<!DOCTYPE html>
<html>
<head>
    <title>Live CE & PE Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        table {
            width: 100%;
            table-layout: fixed;
            text-align: center;
            font-size: 6.9px;
        }
        th {
            background-color: #f8f9fa;
            font-size: 7px; 
            padding: 6px;
        }
        th, td {
            padding: 6px;
            min-width: 140px;
        }
        body {
            zoom: 130%;
        }
    </style>
</head>
<body class="bg-light">

    <!-- Flex container for JSON (left) and controls (right) -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; padding: 10px;">
        
        <!-- Left: Order status JSON -->
        <div id="order-status" style="text-align:left; font-size:8px; white-space:pre-wrap; flex: 1;">
            Loading order status...
        </div>

        <!-- Right: Live data controls -->
        <div style="text-align:right; flex: 1;">
            <h3 style="font-size: 10px; margin: 0;">üìà Live Option Data</h3>
            <p class="text-muted" id="countdown" style="font-size: 8px; margin: 2px 0;">üîÑ Refreshing in 10s</p>
            <a href="{{ url_for('order_status_current') }}" class="btn btn-info btn-sm" target="_blank" style="font-size: 10px; padding: 4px 8px;">
                üìã View Current Order Status
            </a>
            <div id="triggered-condition-block" style="margin-top: 5px;"></div>
        </div>
    </div>

    <script>
    async function fetchOrderStatus() {
        try {
            const res = await fetch('/order-status?ts=' + new Date().getTime()); // cache-buster
            const data = await res.json();

            let table = `<table class="table table-bordered table-sm table-striped" style="font-size: 8px; text-align:left;">
                <thead class="table-light">
                    <tr>
                        <th colspan="2" class="text-center" style="font-size:10px; font-weight:bold; letter-spacing:0.5px;">
                            DAILY ORDER STATUS - (2 TRADES LIMIT PER DAY)
                        </th>
                    </tr>
                </thead>
                <tbody>`;

            for (const [key, value] of Object.entries(data)) {
                table += `
                    <tr>
                        <td style="width:40%; font-weight:bold;">${key}</td>
                        <td>${typeof value === 'object' ? JSON.stringify(value) : value}</td>
                    </tr>`;
            }

            table += `</tbody></table>`;
            document.getElementById('order-status').innerHTML = table;
        } catch (err) {
            document.getElementById('order-status').innerHTML = "<p class='text-danger'>Error loading order status.</p>";
            console.error(err);
        }
    }

    // fetch immediately on load
    fetchOrderStatus();

    // refresh every 10 seconds
    setInterval(fetchOrderStatus, 10000);
    </script>
    
    <div class="container py-5">

        <div class="row mt-4">
            <div class="col-md-6">
                <div id="ce-order-status" class="text-center fw-bold mt-2" style="font-size: 10px;"></div>
                <h5 class="text-center" id="ce-title" style="font-size: 10px;">Loading CE Symbol...</h5>
                <div id="ce-table" class="mt-2">
                    <p class="text-muted">‚åõ Loading CE data...</p>
                </div>
            </div>

            <div class="col-md-6">
                <div id="pe-order-status" class="text-center fw-bold mt-2" style="font-size: 10px;"></div>
                <h5 class="text-center" id="pe-title" style="font-size: 10px;">Loading PE Symbol...</h5>
                <div id="pe-table" class="mt-2">
                    <p class="text-muted">‚åõ Loading PE data...</p>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <a href="/" class="btn btn-primary">‚¨ÖÔ∏è Back</a>
        </div>
    </div>

<script>
    let seconds = 6;
    let countdownInterval = null;
    let isServerAlive = true;

    async function fetchData() {
        if (!isServerAlive) return;

        try {
            const response = await fetch('/data');
            if (!response.ok) throw new Error("Server response not OK");

            const data = await response.json();

            document.getElementById('ce-table').innerHTML = data.ce_table || "<p>Loading CE data...</p>";
            document.getElementById('pe-table').innerHTML = data.pe_table || "<p>Loading PE data...</p>";
            document.getElementById('ce-title').textContent = data.ce_symbol || "Call Option (CE)";
            document.getElementById('pe-title').textContent = data.pe_symbol || "Put Option (PE)";

            if (data.ce_order_msg) {
                let msg = data.ce_order_msg.message || JSON.stringify(data.ce_order_msg);
                document.getElementById('ce-order-status').textContent = `CE Order: ${msg}`;
                document.getElementById('ce-order-status').className = data.ce_order_msg.status === "error" ? "text-danger fw-bold" : "text-success fw-bold";
            } else {
                document.getElementById('ce-order-status').textContent = "";
            }

            if (data.pe_order_msg) {
                let msg = data.pe_order_msg.message || JSON.stringify(data.pe_order_msg);
                document.getElementById('pe-order-status').textContent = `PE Order: ${msg}`;
                document.getElementById('pe-order-status').className = data.pe_order_msg.status === "error" ? "text-danger fw-bold" : "text-success fw-bold";
            } else {
                document.getElementById('pe-order-status').textContent = "";
            }

            // ‚úÖ Triggered Condition Display
            const conditionDiv = document.getElementById('triggered-condition-block');
            conditionDiv.innerHTML = `<p class="fw-bold text-primary" style="font-size: 10px;">üö¶ Triggered Condition : ${data.triggered_condition || "No condition matched"}</p>`;

        } catch (err) {
            console.error("‚ùå JS Fetch Error:", err);
            isServerAlive = false;

            clearInterval(countdownInterval);
            clearInterval(refreshInterval);

            document.getElementById('countdown').textContent = "‚õî Updates stopped";
        }
    }

    function updateCountdown() {
        if (!isServerAlive) return;

        document.getElementById('countdown').textContent = `üîÑ Refreshing in ${seconds}s`;
        seconds--;
        if (seconds < 0) {
            fetchData();
            seconds = 6;
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            fetchData();
            seconds = 3;
        }, 1000);

        countdownInterval = setInterval(updateCountdown, 1000);
    });
</script>

</body>
</html>
