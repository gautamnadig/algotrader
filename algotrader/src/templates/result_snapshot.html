<!DOCTYPE html>
<html>
<head>
    <title>Live CE & PE Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        table {
            width: 100%;
            table-layout: fixed;
            text-align: center;
            font-size: 6.9px;
        }
        th {
            background-color: #f8f9fa;
            font-size: 7px; 
            padding: 6px;
        }
        th, td {
            padding: 6px;
            min-width: 140px;
        }
        body {
            zoom: 130%;
        }
    </style>
</head>
<body class="bg-light">

    <div class="text-center my-4">
        <a href="/order-status" target="_blank" class="btn btn-outline-info" style="font-size: 10px; padding: 4px 8px;">
            üßæ View Order Status for Today
        </a>
    </div>

    <div class="container py-5">
        <h3 class="text-center mb-4" style="font-size: 10px;">üìà Live Option Data </h3>
        <p class="text-center text-muted" id="countdown" style="font-size: 8px;">üîÑ Refreshing in 10s</p>

        <div class="text-center mt-4">
            <a href="{{ url_for('order_status_current') }}" class="btn btn-info" target="_blank" style="font-size: 10px; padding: 4px 8px;">
                üìã View Current Order Status
            </a>
        </div>

        <!-- ‚úÖ Triggered condition block -->
        <div id="triggered-condition-block" class="text-center mt-4"></div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div id="ce-order-status" class="text-center fw-bold mt-2" style="font-size: 10px;"></div>
                <h5 class="text-center" id="ce-title" style="font-size: 10px;">Loading CE Symbol...</h5>
                <div id="ce-table" class="mt-2">
                    <p class="text-muted">‚åõ Loading CE data...</p>
                </div>
            </div>

            <div class="col-md-6">
                <div id="pe-order-status" class="text-center fw-bold mt-2" style="font-size: 10px;"></div>
                <h5 class="text-center" id="pe-title" style="font-size: 10px;">Loading PE Symbol...</h5>
                <div id="pe-table" class="mt-2">
                    <p class="text-muted">‚åõ Loading PE data...</p>
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <a href="/" class="btn btn-primary">‚¨ÖÔ∏è Back</a>
        </div>
    </div>

    <script>
    let seconds = 10;

    async function fetchData() {
        console.log("üöÄ fetchData() called");
        try {
            const response = await fetch('/data');
            const data = await response.json();

            document.getElementById('ce-table').innerHTML = data.ce_table || "<p>Loading CE data...</p>";
            document.getElementById('pe-table').innerHTML = data.pe_table || "<p>Loading PE data...</p>";
            document.getElementById('ce-title').textContent = data.ce_symbol || "Call Option (CE)";
            document.getElementById('pe-title').textContent = data.pe_symbol || "Put Option (PE)";

            if (data.ce_order_msg) {
                let msg = data.ce_order_msg.message || JSON.stringify(data.ce_order_msg);
                document.getElementById('ce-order-status').textContent = `CE Order: ${msg}`;
                document.getElementById('ce-order-status').className = data.ce_order_msg.status === "error" ? "text-danger fw-bold" : "text-success fw-bold";
            } else {
                document.getElementById('ce-order-status').textContent = "";
            }

            if (data.pe_order_msg) {
                let msg = data.pe_order_msg.message || JSON.stringify(data.pe_order_msg);
                document.getElementById('pe-order-status').textContent = `PE Order: ${msg}`;
                document.getElementById('pe-order-status').className = data.pe_order_msg.status === "error" ? "text-danger fw-bold" : "text-success fw-bold";
            } else {
                document.getElementById('pe-order-status').textContent = "";
            }

            // ‚úÖ Triggered Condition Display
           const conditionDiv = document.getElementById('triggered-condition-block');
           conditionDiv.innerHTML = `<p class="fw-bold text-primary" style="font-size: 10px;">üö¶ Triggered Condition : ${data.triggered_condition || "No condition matched"}</p>`;

        } catch (err) {
            console.error("‚ùå JS Fetch Error:", err);
            document.getElementById('ce-table').innerHTML = "<p class='text-danger'>Error loading CE data</p>";
            document.getElementById('pe-table').innerHTML = "<p class='text-danger'>Error loading PE data</p>";
        }
    }

    function updateCountdown() {
        document.getElementById('countdown').textContent = `üîÑ Refreshing in ${seconds}s`;
        seconds--;
        if (seconds < 0) {
            fetchData();
            seconds = 10;
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            console.log("üïë First fetch after 3s");
            fetchData();
            seconds = 3;
        }, 1000);

        setInterval(updateCountdown, 1000);
    });
    </script>

</body>
</html>
